<script type="text/x-red" data-template-name="Spark Payload Parser">
  <div class="form-row" id="node-input-parser-row">
    <label for="node-input-parser"><i class="fa fa-search"></i> Parse</label>
      <input type="text" id="node-input-parser" placeholder="roomId">
  </div>

  <div class="form-row" id="node-input-output-row">
    <label for="node-input-output"><i class="fa fa-arrow-right"></i> Output</label>
      <select type="text" id="node-input-output">
        <option value="original">the orignal property value</option>
        <option value="object">a key/value object</option>
      </select>
  </div>

  <div class="form-row">
    <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
    <input type="text" id="node-input-topic" placeholder="optionally override topic...">
  </div>
</script>

<script type="text/x-red" data-help-name="Spark Payload Parser">
  <p>The Spark Parse Node allows parsing of messages received from either the
    Webhook or API Node. The parsed value is placed in the
    <code>msg.payload</code> of the first output. The value of the "parse" field
    is delivered in <code>msg.topic</code> for use with supporting functions
    like <code>join</code>. The original <code>msg.payload</code> is passed
    through to the second output.
  </p>

  <p>The output specifies how the <code>msg.payload</code> is formatted. Options
    are:
    <ul>
      <li>original - The original value of the property without modifying data
      type.</li>
      <li>object - The original value of the property placed into an object with
      the object key being the parser value, or optionally the topic if
      specified.</li>
    </ul>
  </p>

  <p>If the parser input receives an array, each element of the array is parsed
    individually. The results are returned as multiple sequential messages to
    the output with each msg having a <code>msg.payload</code> and
    <code>msg.topic</code> property.
  </p>

  <!-- Footer -->
  <p>For further details and examples, reference the
    <a href="https://github.com/nmarus/node-red-contrib-spark/blob/master/README.md" target="_blank">README.md</a>
    file in the github repository.
  </p>
</script>

<script type="text/javascript">
  // register the spark api node
  RED.nodes.registerType('Spark Payload Parser', {
    category: 'cisco_spark',
    paletteLabel: 'parser',
    color: '#C0DEED',
    defaults: {
      parser: {
        value: '',
        required: true
      },
      output: {
        value: ''
      },
      topic: {
        value: ''
      },
      name: {
        value: ''
      }
    },
    inputs: 1,
    outputs: 2,
    icon: 'spark-node-red.png',
    label: function() {
      if(this.parser && this.output) {
        this.name = 'parse â†’ ' + this.parser;
        return this.name;
      }

      else {
        return 'Spark Payload Parser';
      }
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    },
    oneditprepare: function() {

      var form = this;

      // event: resource updated
      $('#node-input-parser').keyup(function() {
        form.name = '';
      });

      // set default output
      if($('#node-input-parser').val() == '') {
        $('#node-input-output').val('original');
      }
    }
  });
</script>
